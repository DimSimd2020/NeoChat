# DNS Tunnel — как это работает

## Проблема

Сценарий: Весь интернет заблокирован, кроме whitelist-доменов.
Даже REALITY не работает (IP твоего VPS попал в чёрный список).

**Но:** DNS-запросы почти никогда не блокируют полностью.
Почему? Потому что без DNS не работает вообще ничего —
даже разрешённые сайты (yandex.ru, gosuslugi.ru) не откроются.

## Идея DNS Tunnel

DNS-запрос — это не только "какой IP у yandex.ru?".
DNS позволяет передавать произвольные данные в:
- **Имени поддомена** (до 253 символов)
- **TXT-записях** (до 65535 байт)

Мы используем DNS как транспортный канал для передачи данных.

---

## Как это выглядит

### Отправка сообщения (запрос)

Ты хочешь отправить "Привет" другу.

1. NeoChat шифрует сообщение: `AES-256-GCM("Привет")` → `0x4a7b2c...`
2. Кодирует в Base32: `JJVYMZLQ...`
3. Разбивает на части по 63 символа (лимит DNS-метки)
4. Формирует DNS-запрос:

```
DNS Query (тип A):
  JJVYMZLQ.msg.alice.chat.neo.example.com
  ↑         ↑   ↑     ↑    ↑   ↑
  данные    тип  кому  сервис  домен
```

5. Твой компьютер отправляет этот DNS-запрос
6. **DNS-резолвер оператора** видит, что `neo.example.com` — это не он, пересылает запрос дальше
7. Запрос доходит до **авторитативного DNS-сервера** `neo.example.com` (это твой VPS)
8. VPS расшифровывает данные из имени поддомена, сохраняет сообщение для Alice

### Получение сообщения (ответ)

Alice хочет проверить новые сообщения.

1. NeoChat делает DNS-запрос:

```
DNS Query (тип TXT):
  poll.alice.chat.neo.example.com
```

2. VPS отвечает TXT-записью с зашифрованными данными:

```
DNS Response:
  TXT "JJVYMZLQ4A7B2C..."  ← зашифрованное сообщение в Base32
```

3. NeoChat расшифровывает → "Привет"

---

## Пример реального трафика

```bash
# Отправка сообщения
$ dig A JJVYMZLQ.msg.alice.chat.neo.example.com
;; ANSWER SECTION:
JJVYMZLQ.msg.alice.chat.neo.example.com. 60 IN A 1.2.3.4

# Получение сообщений
$ dig TXT poll.alice.chat.neo.example.com
;; ANSWER SECTION:
poll.alice.chat.neo.example.com. 60 IN TXT "KBZWC4TBNRSS4Y3PNUXXK43UEB2GQZJAN5XCA2LOEBRW63I="
```

Для DPI это выглядит как обычные DNS-запросы.
Никаких подозрительных протоколов, никакого HTTPS, никакого шифрования
(с точки зрения DPI — просто DNS).

---

## Нужен ли VPS?

**Да, нужен свой DNS-сервер.**

Варианты:

### 1. Свой VPS с DNS-сервером ($3-5/мес)
```bash
# На VPS ставишь bind9 или PowerDNS
apt install bind9

# Настраиваешь зону neo.example.com
# Скрипт парсит входящие запросы и формирует ответы
```

### 2. Cloudflare Workers + DNS API (бесплатно!)

Cloudflare позволяет обрабатывать DNS-запросы через Workers:

```javascript
// Cloudflare Worker — обработчик DNS
addEventListener('fetch', event => {
  event.respondWith(handleDNS(event.request))
})

async function handleDNS(request) {
  const url = new URL(request.url);
  const hostname = url.hostname;
  
  // Парсим: JJVYMZLQ.msg.alice.chat.neo.example.com
  const parts = hostname.split('.');
  const data = parts[0];  // JJVYMZLQ
  const type = parts[1];  // msg
  const user = parts[2];  // alice
  
  if (type === 'msg') {
    // Сохраняем сообщение в KV storage
    await MESSAGES.put(`${user}:${Date.now()}`, data);
    return new Response('1.2.3.4');  // Фейковый IP
  }
  
  if (type === 'poll') {
    // Достаём сообщения для пользователя
    const messages = await MESSAGES.list({ prefix: `${user}:` });
    const data = messages.keys.map(k => k.name).join(',');
    return new Response(data, {
      headers: { 'Content-Type': 'text/plain' }
    });
  }
}
```

**Плюс Cloudflare:**
- Бесплатный план: 100,000 запросов/день
- Cloudflare IP обычно не блокируют
- Не нужен свой VPS

**Минус:**
- Cloudflare может заблокировать за ToS violation
- Cloudflare видит метаданные (кто с кем общается, когда)

### 3. Публичные DNS-туннели (не рекомендую)

Есть публичные сервисы типа `dns2tcp`, `iodine`, но:
- Медленные (все пользуются)
- Ненадёжные (могут закрыться)
- Небезопасные (владелец видит трафик)

---

## Скорость DNS Tunnel

**Теоретический максимум:**

```
DNS-запрос:
  - Имя поддомена: до 253 символов
  - Base32 encoding: 253 * 5/8 ≈ 158 байт данных
  - Минус служебная информация: ~100 байт полезной нагрузки

DNS-ответ (TXT):
  - До 255 байт на строку, можно несколько строк
  - Реально: ~500-1000 байт на ответ

Частота запросов:
  - Без палева: 1 запрос в 1-5 секунд
  - Агрессивно: 10-20 запросов в секунду (но палевно)
```

**Реальная скорость:**
- Консервативно: **1-5 КБ/с** (достаточно для текста)
- Агрессивно: **10-50 КБ/с** (но DPI может заметить аномалию)

**Для сравнения:**
- Текстовое сообщение: ~1 КБ
- Голосовое (сжатое): ~8 КБ/с
- Фото (сжатое): ~100-500 КБ

**Вывод:** Для текстовых сообщений DNS Tunnel вполне рабочий.
Для фото/видео — слишком медленно.

---

## Безопасность

**Что видит DNS-резолвер оператора:**
- Имена поддоменов (зашифрованные данные в Base32)
- Частоту запросов
- IP твоего DNS-сервера

**Что НЕ видит:**
- Содержимое сообщений (зашифровано E2E)
- Кто кому пишет (только хеши ID)

**Что видит твой DNS-сервер (VPS):**
- IP отправителя (можно скрыть через Tor)
- Хеш ID получателя
- Зашифрованные данные (не может расшифровать)

---

## Когда использовать DNS Tunnel

```
Уровень блокировки:
  Лёгкая   → Прямой P2P (QUIC)
  Средняя  → CDN Relay (Cloudflare)
  Тяжёлая  → REALITY (маскировка)
  Жёсткая  → DNS Tunnel ← ты здесь
  Полная   → SMS или Mesh (Bluetooth)
```

DNS Tunnel — это когда:
- ❌ Весь интернет заблокирован
- ❌ REALITY не работает (IP в чёрном списке)
- ✅ DNS-запросы ещё проходят
- ✅ Нужно передать текст (не файлы)

---

## Альтернатива без VPS: ICMP Tunnel

Если даже DNS блокируют, есть ещё **ICMP** (ping).

```bash
# Отправка данных через ping
ping -c 1 -p "48656c6c6f" example.com
                ↑
                Hex-encoded "Hello"
```

ICMP блокируют крайне редко (ломается диагностика сети).
Но это ещё медленнее DNS и требует root/admin прав.

---

## Итог

| Вопрос | Ответ |
|--------|-------|
| Нужен VPS? | Да, или Cloudflare Workers (бесплатно) |
| Скорость? | 1-5 КБ/с (текст OK, файлы нет) |
| Когда использовать? | Когда всё остальное заблокировано |
| Приоритет для NeoChat? | Низкий (сначала Mesh, потом SMS) |

Для массового мессенджера **DNS Tunnel не подходит** как основной канал.
Но как **запасной вариант** для экстремальных случаев — вполне.

**Рекомендация:** Сфокусироваться на **Mesh (Bluetooth/WiFi)** — это $0 при любом масштабе.
